<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 18px;
      box-sizing: border-box;
      color: #202124;
    }
    h2 {
      font-size: 20px;
      margin: 0 0 8px;
      color: #1a73e8;
      text-align: center;
      font-weight: 600;
    }
    p {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
      margin-bottom: 10px;
      text-align: center;
    }
    .hint {
      font-size: 11px;
      color: #666;
      margin-bottom: 10px;
      text-align: left;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .left-actions, .right-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .dialog-header {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 0 6px;
}

    .back-btn {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background-color: #f1f3f4;
      color: #202124;
    }
    .dialog-title {
  font-size: 20px;
  font-weight: 600;
  color: #1a73e8;
  line-height: 1.2;
}



    button {
      border-radius: 6px;
      border: none;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
    }
    button.primary {
      background-color: #1a73e8;
      color: #fff;
    }
    button.secondary {
      background-color: #f1f3f4;
      color: #202124;
    }
    button.danger {
      background-color: #d93025;
      color: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .table-container {
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: auto;
      max-height: 320px;
      margin-bottom: 10px;
    }

    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 3px 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 12px;
    }

    .footer-bar {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    #status {
      font-size: 12px;
      color: #444;
      white-space: pre-line;
    }

    @media (max-width: 480px) {
      .toolbar, .footer-bar {
        flex-direction: column;
        align-items: stretch;
      }
      button {
        width: 100%;
      }
    }

    /* ===== Custom Confirm Modal ===== */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(32, 33, 36, 0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999999;
}

.modal {
  width: min(420px, calc(100vw - 32px));
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  overflow: hidden;
  border: 1px solid #e0e0e0;
}

.modal-header {
  padding: 12px 14px;
  border-bottom: 1px solid #eee;
  font-weight: 600;
  font-size: 14px;
  color: #202124;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-body {
  padding: 12px 14px;
  font-size: 12px;
  color: #444;
  line-height: 1.4;
  white-space: pre-line;
}

.modal-actions {
  padding: 12px 14px;
  border-top: 1px solid #eee;
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

button.modal-btn {
  border-radius: 6px;
  border: none;
  padding: 6px 10px;
  font-size: 12px;
  cursor: pointer;
  font-weight: 600;
}

button.modal-cancel {
  background-color: #f1f3f4;
  color: #202124;
}

button.modal-ok {
  background-color: #1a73e8;
  color: #fff;
}

button.modal-ok.danger {
  background-color: #d93025;
  color: #fff;
}

/* ‚úÖ Brand logo INSIDE modal (sticky bottom, does not overlay scrollbar) */
.brand-sticky-bottom{
  position: sticky;
  bottom: 0;
  z-index: 5;
  display: flex;
  justify-content: flex-end;  /* lower-right */
  padding: 8px 0 2px;
  background: #fff;
}


  </style>
  <?!= include_('UiTheme'); ?>
</head>
<body class="ui-page">
  <div class="dialog-header">
  <div class="dialog-title">Chart of Accounts</div>
</div>




  <p>Maintain your COA line by line, or import from CSV.</p>

  <div class="hint">
    Columns used:<br>
    <b>Account Code</b> ‚Äì e.g. 6000<br>
    <b>Account Name</b> ‚Äì e.g. Salaries Expense
  </div>

  <div class="toolbar">
    <div class="left-actions">
      <button class="secondary" type="button" onclick="addLine()">‚ûï Add line</button>
      <button class="secondary" type="button" onclick="clearAll()">üßπ Clear all</button>
    </div>
    <div class="right-actions">
  <button class="secondary" type="button" onclick="triggerCsvImport()">üì• Import CSV</button>
  <button class="secondary" type="button" onclick="syncCoaFromApi()">üîÑ Sync COA (API)</button>
  <input type="file" id="csvFile" accept=".csv,text/csv" style="display:none" />
</div>

  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th style="width:25%;">Account Code</th>
          <th>Account Name</th>
          <th style="width:40px;">&nbsp;</th>
        </tr>
      </thead>
      <tbody id="coaBody"></tbody>
    </table>
  </div>

  <div class="footer-bar">
    <div id="status"></div>
    <div>
      <button class="secondary" type="button" onclick="goBackToPayrollPosting()">Close</button>

      <button class="primary" type="button" onclick="saveCoa()">Save</button>
    </div>
  </div>

  <div class="brand-sticky-bottom">
  <?!= include_('BrandWatermarkInline'); ?>
</div>

  <script>
    // ===== RENDERING =====
    function renderRows(coa) {
      const tbody = document.getElementById('coaBody');
      tbody.innerHTML = '';

      if (!Array.isArray(coa) || !coa.length) {
        addLine();
        return;
      }

      coa.forEach(row => addLine(row.code, row.name));
    }

    // ===== Custom Confirm Modal (replaces window.confirm) =====
function uiConfirm_(opts) {
  opts = opts || {};
  const title = String(opts.title || 'Confirm');
  const message = String(opts.message || '');
  const okText = String(opts.okText || 'OK');
  const cancelText = String(opts.cancelText || 'Cancel');
  const danger = opts.danger === true;

  const backdrop = document.getElementById('confirmBackdrop');
  const titleEl = document.getElementById('confirmTitle');
  const msgEl = document.getElementById('confirmMessage');
  const okBtn = document.getElementById('confirmOkBtn');
  const cancelBtn = document.getElementById('confirmCancelBtn');
  const xBtn = document.getElementById('confirmXBtn');

  titleEl.textContent = title;
  msgEl.textContent = message;

  okBtn.textContent = okText;
  cancelBtn.textContent = cancelText;

  if (danger) okBtn.classList.add('danger');
  else okBtn.classList.remove('danger');

  backdrop.style.display = 'flex';

  return new Promise(resolve => {
    let done = false;

    function close(result) {
      if (done) return;
      done = true;

      backdrop.style.display = 'none';

      okBtn.removeEventListener('click', onOk);
      cancelBtn.removeEventListener('click', onCancel);
      xBtn.removeEventListener('click', onCancel);
      backdrop.removeEventListener('click', onBackdrop);
      document.removeEventListener('keydown', onKeyDown);

      resolve(result);
    }

    function onOk() { close(true); }
    function onCancel() { close(false); }
    function onBackdrop(e) {
      // Click outside modal closes as cancel
      if (e.target === backdrop) close(false);
    }
    function onKeyDown(e) {
      if (e.key === 'Escape') close(false);
      if (e.key === 'Enter') close(true);
    }

    okBtn.addEventListener('click', onOk);
    cancelBtn.addEventListener('click', onCancel);
    xBtn.addEventListener('click', onCancel);
    backdrop.addEventListener('click', onBackdrop);
    document.addEventListener('keydown', onKeyDown);

    // focus ok by default
    setTimeout(() => okBtn.focus(), 0);
  });
}


    function addLine(code = '', name = '') {
      const tbody = document.getElementById('coaBody');
      const tr = document.createElement('tr');

      // Account code
      const tdCode = document.createElement('td');
      const inpCode = document.createElement('input');
      inpCode.type = 'text';
      inpCode.value = code || '';
      tdCode.appendChild(inpCode);
      tr.appendChild(tdCode);

      // Account name
      const tdName = document.createElement('td');
      const inpName = document.createElement('input');
      inpName.type = 'text';
      inpName.value = name || '';
      tdName.appendChild(inpName);
      tr.appendChild(tdName);

      // Remove
      const tdDel = document.createElement('td');
      const btnDel = document.createElement('button');
      btnDel.type = 'button';
      btnDel.textContent = '‚úï';
      btnDel.className = 'danger';
      btnDel.style.padding = '2px 6px';
      btnDel.onclick = () => {
        tr.remove();
        if (!document.getElementById('coaBody').rows.length) {
          addLine();
        }
      };
      tdDel.appendChild(btnDel);
      tr.appendChild(tdDel);

      tbody.appendChild(tr);
    }

    async function clearAll() {
  const ok = await uiConfirm_({
    title: 'Clear all?',
    message: 'Clear all COA lines?\n\nThis is not saved until you click Save.',
    okText: 'Clear',
    cancelText: 'Cancel',
    danger: true
  });
  if (!ok) return;

  document.getElementById('coaBody').innerHTML = '';
  addLine();
  setStatus('Cleared. Not yet saved.');
}


    // ===== LOAD EXISTING COA =====
    function load() {
  setStatus('Loading‚Ä¶');
  google.script.run
    .withSuccessHandler(coa => {
      renderRows(coa);
      setStatus('');
    })
    .withFailureHandler(err => {
      setStatus('‚ùå Failed to load COA: ' + (err && err.message ? err.message : err));
      // still show one empty line so UI isn't dead
      renderRows([]);
    })
    .getCoaAccounts();
}

    // ===== COLLECT + SAVE =====
    function collectCoa() {
      const tbody = document.getElementById('coaBody');
      const rows = [];
      Array.from(tbody.rows).forEach(tr => {
        const code = tr.cells[0].querySelector('input').value.trim();
        const name = tr.cells[1].querySelector('input').value.trim();
        if (!code) return; // skip empty lines
        rows.push({ code, name, type: '' });
      });
      return rows;
    }

    async function saveCoa() {
  const data = collectCoa();

  if (!data.length) {
    const ok = await uiConfirm_({
      title: 'Save empty COA?',
      message: 'No non-empty lines found.\nSave an empty COA?',
      okText: 'Save',
      cancelText: 'Cancel'
    });
    if (!ok) return;
  }

  setStatus('Saving‚Ä¶');

  google.script.run
    .withSuccessHandler(res => {
      setStatus(`‚úÖ Saved ${(res && res.count) || 0} accounts.`);
      // do NOT close automatically
    })
    .withFailureHandler(err => {
      setStatus('‚ùå Error saving COA: ' + (err && err.message ? err.message : err));
    })
    .saveCoa(data);
}

    async function syncCoaFromApi() {
  const ok = await uiConfirm_({
    title: 'Sync Chart of Accounts',
    message: 'Sync Chart of Accounts from your connected accounting system?\n\nThis will overwrite the current table.\n(Not yet saved until you click Save.)',
    okText: 'Sync',
    cancelText: 'Cancel'
  });
  if (!ok) return;

  setStatus('Syncing COA from Accounting API‚Ä¶');

  google.script.run
    .withSuccessHandler(res => {
      google.script.run
        .withSuccessHandler(coa => {
          renderRows(Array.isArray(coa) ? coa : []);
          setStatus(`‚úÖ COA synced (${(res && res.count) || 0}). Review then click Save.`);
        })
        .withFailureHandler(err2 => {
          setStatus('‚ö† Synced, but failed to reload COA list: ' + (err2.message || err2));
        })
        .getCoaAccounts();
    })
    .withFailureHandler(err => {
      setStatus('‚ùå COA sync failed: ' + (err.message || err));
    })
    .syncCoaFromAccountingSystem();
}



    // ===== CSV IMPORT =====
    function triggerCsvImport() {
      document.getElementById('csvFile').click();
    }

    document.getElementById('csvFile').addEventListener('change', handleCsvFile);

    function handleCsvFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = reader.result || '';
          const rows = parseCsv(text);
          if (!rows.length) {
            setStatus('No valid rows found in CSV.');
            return;
          }
          renderRows(rows);
          setStatus(`Imported ${rows.length} accounts from CSV (not yet saved).`);
        } catch (err) {
          setStatus('‚ùå Error parsing CSV: ' + err);
        }
      };
      reader.readAsText(file);
    }

    function parseCsv(text) {
      const lines = text.split(/\r?\n/);
      const out = [];
      lines.forEach((line, idx) => {
        const trimmed = line.trim();
        if (!trimmed) return;

        // very simple split: try comma, then semicolon, then tab
        let parts = trimmed.split(',');
        if (parts.length < 2) parts = trimmed.split(';');
        if (parts.length < 2) parts = trimmed.split('\t');
        if (parts.length < 1) return;

        const code = (parts[0] || '').trim();
        const name = (parts[1] || '').trim();
        if (!code) return;
        out.push({ code, name, type: '' });
      });
      return out;
    }

    // ===== STATUS =====
    function setStatus(msg) {
      document.getElementById('status').textContent = msg || '';
    }

    
    window.onload = load;
    function goBackToPayrollPosting() {
  setStatus('Returning‚Ä¶');
  google.script.run
    .withSuccessHandler(() => google.script.host.close())
    .withFailureHandler(err => {
      setStatus('‚ùå Close failed: ' + (err && err.message ? err.message : err));
    })
    .showPayrollPostingDialog();
}


  </script>

  <!-- ===== Confirm Modal (replaces window.confirm) ===== -->
<div id="confirmBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-header">
      <span id="confirmTitle">Confirm</span>
      <button type="button" class="modal-btn modal-cancel" id="confirmXBtn" style="padding:4px 8px;">‚úï</button>

    </div>
    <div class="modal-body" id="confirmMessage"></div>
    <div class="modal-actions">
      <button type="button" class="modal-btn modal-cancel" id="confirmCancelBtn">Cancel</button>
      <button type="button" class="modal-btn modal-ok" id="confirmOkBtn">OK</button>
    </div>
  </div>
</div>


</body>
</html>
