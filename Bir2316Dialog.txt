<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <?!= include_('UiTheme'); ?>
  <style>
    /* =========
       Layout
       ========= */
    .form-container{
      padding: 16px 18px;
      padding-bottom: 16px; /* ✅ remove huge reserved space */
    }

    html, body { height: 100%; margin: 0; }

/* make the dialog layout: header (h1) + scroll area + footer */
body.ui-page{
  padding: 0 !important;     /* override UiTheme padding */
  overflow: hidden;          /* ✅ stop body scrolling */
  display: flex;
  flex-direction: column;
}

/* keep your title visible, not inside the scroller */
h1{
  margin: 0;
  padding: 16px 18px 0;
}

/* ✅ scroll happens here, not on body */
.form-container{
  flex: 1;
  overflow-y: auto;
  padding: 16px 18px;
  box-sizing: border-box;
}


    /* === STICKY FOOTER (Progress + Actions) === */
.footer {
  border-top: 1px solid #ddd;
  padding: 14px 20px;
  background: #fafafa;
  box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
  position: sticky;
  bottom: 0;
  z-index: 5;
}

/* Footer actions must be centered regardless of UiTheme defaults */
.footer .button-group{
  display: flex;
  justify-content: center;
  gap: 8px;
  flex-wrap: wrap; /* optional, but prevents overflow on small dialogs */
}

    #status {
  font-size: 13px;
  color: #333;
  white-space: pre-line;
  text-align: left;
  margin-top: 6px;
}

    #progressBarContainer { width: 100%; background: #eee; border-radius: 10px; height: 22px; overflow: hidden; margin-top: 8px; }
    #progressBar { width: 0%; height: 100%; text-align: center; line-height: 22px; background: #1a73e8; color: #fff; transition: width .2s; }
    #progressStatus { margin-top: 6px; font-size: 12px; color: #444; }

    html, body { overflow-x: hidden; }

    /* =========
       Employee list
       ========= */
    #employeeList{
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      max-height: 240px;
      overflow-y: auto;
      background: #fff;
    }

    .button-group.emp-actions{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:nowrap;
  width:100%;
  overflow:hidden;
  margin-bottom: 10px; /* ✅ space before #employeeList */
}

    .button-group.emp-actions > button{
      flex:0 0 auto;
      white-space:nowrap;
    }
    .button-group.emp-actions .bulk-actions{
  display:flex;
  gap:10px;              /* a bit wider so it’s obvious */
  margin-left:auto;
  flex:1 1 auto;
  min-width:0;
}

/* ✅ make the separation visible even if buttons are same color */
.button-group.emp-actions .bulk-actions > button{
  border: 1px solid #fff;     /* white divider line */
}

    .button-group.emp-actions .bulk-actions > button{
      flex:1 1 0;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:8px 10px;
      font-size:12px;
      border-radius:10px;
    }

    /* Employee list row layout */
    .emp-row{
      display:grid;
      grid-template-columns: 22px 1fr 88px 70px;
      gap:10px;
      align-items:center;
      padding:4px 0;
    }
    .emp-row .emp-name{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .emp-row button.mini{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #dadce0;
      background:#fff;
      cursor:pointer;
      font-size:12px;
      line-height:1;
    }
    .emp-row button.mini.primary{
      background:#1a73e8 !important;
      border-color:#1a73e8 !important;
      color:#fff !important;
    }
    .emp-row button.mini.primary:hover{ filter:brightness(0.95); }
    .emp-row input[type="checkbox"]{ width:16px; height:16px; margin:0; }

    /* =========
       Email section toggle
       ========= */
    .checkline{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:6px;
    }
    .checkline label{ margin:0; cursor:pointer; }

    /* keep email section tight */
    #emailSection{ margin-top: 8px; }

    /* =========
       Bottom action buttons (Preview/Cancel/Show Tags)
       ========= */
    /* Only neutralize any theme sticky behavior inside sections (NOT inside the footer) */
.section .button-group{
  position: static !important;
  bottom: auto !important;
  top: auto !important;
}


    /* ✅ Keep them in one row */
    .section .button-group:not(.emp-actions){
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      align-items:center;
    }
    .section .button-group:not(.emp-actions) > button{
      flex:0 0 auto;
      white-space:nowrap;
    }

    pre.tagbox{
      margin: 8px 0 0;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 8px;
      max-height: 220px;
      overflow: auto;
      font-size: 11px;
      background: #fafafa;
    }

/* ✅ Brand logo INSIDE modal (sticky bottom, does not overlay scrollbar) */
.brand-sticky-bottom{
  position: sticky;
  bottom: 0;
  z-index: 5;
  display: flex;
  justify-content: flex-end;  /* lower-right */
  padding: 8px 0 2px;
  background: #fff;
}

/* Filters layout: Search full row, dims beside each other */
.filters{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin:10px 0;
  align-items:flex-end;
}
.filters .filter{ min-width:200px; }
.filters .search{ flex: 1 1 100%; }   /* full row */
.filters .dim{ flex: 1 1 0; }         /* side-by-side */
.filters input, .filters select{ width:100%; }

/* Checkbox filter boxes */
.filter-box{
  border: 1px solid #ccc;
  border-radius: 6px;
  background: #fff;
  padding: 6px;
  height: 140px;
  overflow: auto;
  font-size: 13px;
}
.filter-box .opt{
  display:flex;
  align-items:center;
  gap:8px;
  padding: 2px 2px;
}
.filter-box input[type="checkbox"]{
  width: 16px;
  height: 16px;
  accent-color: #1a73e8;
}



  </style>
</head>

<body class="ui-page">
  <h1>Generate BIR 2316</h1>

  <div class="form-container">

    <div class="section">
      <label>Tax Year</label>
      <select id="yearSelect" onchange="loadEmployeesAndMaybeTags()"></select>
      <div class="hint">Uses <b>Annualization - YYYY</b> (Final Annualization output).</div>
    </div>

    <div class="section">
      <label>Employees</label>

      <div class="button-group emp-actions">
  <button class="secondary" type="button" onclick="selectAll(true)">Select All</button>
  <button class="secondary" type="button" onclick="selectAll(false)">Clear All</button>
  <button class="secondary" type="button" onclick="refreshEmployees()">Refresh</button>

  <div class="bulk-actions">
    <button class="primary" type="button" onclick="downloadSelected()">Download Selected</button>
    <button class="primary" type="button" onclick="sendSelected()">Send Selected</button>
  </div>
</div>

<!-- ✅ Filters (same behavior as Payslip) -->
<div class="filters">
  <div class="filter search">
    <label style="margin:0;">Search</label>
    <input id="empSearch" type="text" placeholder="Search employee…">
  </div>

  <div class="filter dim">
    <label id="dim1Label" style="margin:0;">Entity</label>
    <div id="dim1Filter" class="filter-box">Loading…</div>
  </div>

  <div class="filter dim">
    <label id="dim2Label" style="margin:0;">Payroll Group</label>
    <div id="dim2Filter" class="filter-box">Loading…</div>
  </div>
</div>

<div id="employeeList">Loading…</div>

    </div>

    <div class="section">
      <label>Output Folder ID / URL</label>
      <input id="folderId" placeholder="Drive Folder ID or URL" />
    </div>

    <div id="slidesTemplateSection" class="section">
      <label>Template Google Slides URL / ID</label>
      <input id="slidesTemplateUrl" placeholder="https://docs.google.com/presentation/d/.../edit" />
    </div>

    <div class="section">
      <label>Filename Pattern</label>
      <input id="filenamePattern" value="{{MF.LAST NAME}}_{{MF.TIN}}000_1231{{YEAR}}" />
      <div class="hint">Tags are case-insensitive. Tags list is shown below.</div>
    </div>

    <div class="section">
      <div class="checkline">
        <label for="sendEmail">Email PDF to employee (attachment)</label>
        <input type="checkbox" id="sendEmail" />
      </div>

      <!-- ✅ EVERYTHING email-related goes inside this block so toggle works -->
      <div id="emailSection" style="display:none;">
        <label style="margin-top:10px;">Employee Email Column (Masterfile)</label>
        <select id="emailColumn"></select>

        <label style="margin-top:10px;">Email Subject</label>
        <input id="emailSubject" placeholder="{{EMPLOYEE NAME}} - BIR 2316 - {{YEAR}}" />

        <label style="margin-top:10px;">Email Body (HTML allowed)</label>
        <textarea id="emailBodyHtml" placeholder="<p>Hi {{EMPLOYEE NAME}},</p><p>Attached is your BIR 2316 for {{YEAR}}.</p>"></textarea>

        <div class="checkline" style="margin-top:10px;">
  <label for="appendGmailSignature">Append my Gmail signature</label>
  <input type="checkbox" id="appendGmailSignature" />
</div>


        <label style="margin-top:10px;">CC</label>
        <input id="cc" placeholder="" />

        <label style="margin-top:10px;">BCC</label>
        <input id="bcc" placeholder="" />

        <label style="margin-top:10px;">Reply-To</label>
        <input id="replyTo" placeholder="" />

        <label style="margin-top:10px;">Sender Name</label>
        <input id="senderName" placeholder="Payroll Team" />
      </div>
    </div>

  </div>


  <div class="footer">
  <div class="button-group">

    <button class="secondary" type="button" onclick="saveSettings()">Save</button>
    <button class="secondary" type="button" onclick="reviewTags()">Review</button>
    <button class="secondary" type="button" onclick="generateAlphalist1604C()">Generate BIR 1604-C Alphalist</button>
    <button class="danger" type="button" onclick="cancelRun()">Cancel</button>
  </div>

  <div id="status"></div>
  <div id="progressBarContainer" style="display:none;">
    <div id="progressBar">0%</div>
  </div>
  <div id="progressStatus"></div>
</div>

<div class="brand-sticky-bottom">
  <?!= include_('BrandWatermarkInline'); ?>
</div>


<script>
  let poller = null;

// ✅ Filter cache (same pattern as Payslip)
let _allEmployees = []; // [{id,name,dim1,dim2}]

// ✅ re-render when filters change
document.addEventListener('input', (e) => {
  if (e && e.target && e.target.id === 'empSearch') renderBir2316Employees_();
});
document.addEventListener('change', (e) => {
  if (e && e.target && e.target.id === 'dim1Filter') renderBir2316Employees_();
});
document.addEventListener('change', (e) => {
  if (e && e.target && e.target.id === 'dim2Filter') renderBir2316Employees_();
});


  document.addEventListener('DOMContentLoaded', () => {
    // reset persisted progress so the bar starts clean every open
    google.script.run
      .withSuccessHandler(() => {
        google.script.run.withSuccessHandler(initUI).getBir2316Init();
        startPolling();
      })
      .resetBir2316Progress();
  });

  function initUI(data) {
    const years = data.years || [];
    const last = data.last || {};
    const defs = data.defaults || {};

    const yearSelect = document.getElementById('yearSelect');
    yearSelect.innerHTML = '';
    years.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y;
      yearSelect.appendChild(opt);
    });
    if (last.year && years.includes(Number(last.year))) yearSelect.value = last.year;

    document.getElementById('folderId').value = last.folderId || '';
    document.getElementById('slidesTemplateUrl').value = last.slidesTemplateUrl || '';
    document.getElementById('filenamePattern').value =
      last.filenamePattern || defs.filenamePattern || '{{MF.LAST NAME}}_{{TIN}}000_1231{{YEAR}}';

    // ✅ checkbox state + dropdown population
    const sendCb = document.getElementById('sendEmail');
    sendCb.checked = !!(last.sendEmail ?? defs.sendEmail);

    populateEmailColumnDropdown(
      data.masterfileHeaders || [],
      last.emailColumn || defs.emailColumn || 'Company Email'
    );

    document.getElementById('emailSubject').value = last.emailSubject || defs.emailSubject || '{{EMPLOYEE NAME}} - BIR 2316 - {{YEAR}}';
    document.getElementById('emailBodyHtml').value = last.emailBodyHtml || defs.emailBodyHtml || '';
    document.getElementById('cc').value = last.cc || defs.cc || '';
    document.getElementById('bcc').value = last.bcc || defs.bcc || '';
    document.getElementById('replyTo').value = last.replyTo || defs.replyTo || '';
    document.getElementById('senderName').value = last.senderName || defs.senderName || 'Payroll Team';

    document.getElementById('appendGmailSignature').checked =
  !!((last && last.appendGmailSignature != null) ? last.appendGmailSignature : (defs && defs.appendGmailSignature));


    // ✅ bind ONCE + force correct visibility after state is set
    if (!sendCb._bound) {
      sendCb.addEventListener('change', toggleEmailSection);
      sendCb._bound = true;
    }

const sigCb = document.getElementById('appendGmailSignature');
if (sigCb && !sigCb._bound) {
  sigCb.addEventListener('change', () => {
    if (!sigCb.checked) return;

    google.script.run
      .withSuccessHandler(sig => {
        sig = String(sig || '').trim();
        if (!sig) return;

        const bodyEl = document.getElementById('emailBodyHtml');
        const bodyNow = String(bodyEl.value || '');

        // prevent double-append
        if (bodyNow.indexOf(sig) !== -1) return;

        bodyEl.value = bodyNow + (bodyNow ? '<br><br>' : '') + sig;
      })
      .withFailureHandler(err => setStatus('⚠️ Could not load Gmail signature: ' + (err && err.message ? err.message : err)))
      .bir2316GetGmailSignature();
  });
  sigCb._bound = true;
}


    toggleEmailSection();

    refreshEmployees();

    const s = document.getElementById('empSearch');
if (s && !s._bound) {
  s.addEventListener('input', renderBir2316Employees_);
  s._bound = true;
}

    
  }

  function toggleEmailSection() {
    const on = document.getElementById('sendEmail').checked;
    const sec = document.getElementById('emailSection');
    if (sec) sec.style.display = on ? 'block' : 'none';
  }

  function refreshEmployees() {
  const year = Number(document.getElementById('yearSelect').value);
  document.getElementById('employeeList').textContent = 'Loading…';

  google.script.run
    .withSuccessHandler(payload => {
      const employees = (payload && payload.employees) ? payload.employees : [];
      const dim1Label = (payload && payload.dim1Label) ? payload.dim1Label : 'Entity';
      const dim2Label = (payload && payload.dim2Label) ? payload.dim2Label : 'Payroll Group';

      const lbl1 = document.getElementById('dim1Label');
      if (lbl1) lbl1.textContent = dim1Label;

      const lbl2 = document.getElementById('dim2Label');
      if (lbl2) lbl2.textContent = dim2Label;

      _allEmployees = employees;

      buildDim1FilterOptions_(_allEmployees);
      buildDim2FilterOptions_(_allEmployees);
      renderBir2316Employees_();
    })
    .withFailureHandler(err => setStatus('❌ ' + (err.message || err)))
    // ✅ NEW: use dim-enabled endpoint
    .getBir2316EmployeesWithDims(year);
}

function _getCheckedValues_(boxEl){
  if (!boxEl) return [];
  return Array.from(boxEl.querySelectorAll('input[type="checkbox"]:checked'))
    .map(cb => String(cb.value || '').trim())
    .filter(Boolean);
}

function _renderCheckboxOptions_(boxEl, values, keepSelected){
  if (!boxEl) return;

  const keep = new Set((keepSelected || []).map(v => String(v).trim()).filter(Boolean));
  const vals = (values || []).map(v => String(v).trim()).filter(Boolean);

  if (!vals.length){
    boxEl.innerHTML = '<div class="hint">No options</div>';
    return;
  }

  boxEl.innerHTML = vals.map(v => {
    const esc = String(v)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    const checked = keep.has(v) ? 'checked' : '';
    return `<label class="opt"><input type="checkbox" value="${esc}" ${checked}>${esc}</label>`;
  }).join('');
}

function buildDim1FilterOptions_(rows) {
  const box = document.getElementById('dim1Filter');
  if (!box) return;

  const keep = _getCheckedValues_(box);
  const uniq = Object.create(null);

  (rows || []).forEach(r => {
    const v = String((r && r.dim1) ? r.dim1 : '').trim();
    if (!v) return;
    uniq[v] = true;
  });

  const vals = Object.keys(uniq).sort((a,b) => a.localeCompare(b));
  _renderCheckboxOptions_(box, vals, keep);

  box.onchange = renderBir2316Employees_;
}

function buildDim2FilterOptions_(rows) {
  const box = document.getElementById('dim2Filter');
  if (!box) return;

  const keep = _getCheckedValues_(box);
  const uniq = Object.create(null);

  (rows || []).forEach(r => {
    const v = String((r && r.dim2) ? r.dim2 : '').trim();
    if (!v) return;
    uniq[v] = true;
  });

  const vals = Object.keys(uniq).sort((a,b) => a.localeCompare(b));
  _renderCheckboxOptions_(box, vals, keep);

  box.onchange = renderBir2316Employees_;
}

function renderBir2316Employees_() {
  const box = document.getElementById('employeeList');

  const qEl = document.getElementById('empSearch');
  const fEl1 = document.getElementById('dim1Filter');
  const fEl2 = document.getElementById('dim2Filter');

  const q = qEl ? String(qEl.value || '').trim().toLowerCase() : '';
  const dim1Sel = _getCheckedValues_(fEl1);
  const dim2Sel = _getCheckedValues_(fEl2);

  const filtered = (_allEmployees || []).filter(e => {
    const name = String(e.name || '');
    const id   = String(e.id || '');
    const hay  = (name + ' ' + id).toLowerCase();

    const okQ  = !q || hay.indexOf(q) >= 0;
    const okD1 = !dim1Sel.length || dim1Sel.includes(String(e.dim1 || '').trim());
    const okD2 = !dim2Sel.length || dim2Sel.includes(String(e.dim2 || '').trim());
    return okQ && okD1 && okD2;
  });

  if (!filtered.length) {
    box.innerHTML = '<i>No employees found.</i>';
    return;
  }

  box.innerHTML = '';
  filtered.forEach(e => {
    const row = document.createElement('div');
    row.className = 'emp-row';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'empChk';
    cb.value = String(e.id || '');
    cb.checked = true;

    const name = document.createElement('div');
    name.className = 'emp-name';
    name.textContent = `${e.name} (${e.id})`;

    const dl = document.createElement('button');
    dl.type = 'button';
    dl.className = 'mini primary';
    dl.textContent = 'Download';
    dl.onclick = () => downloadOne(String(e.id || ''));

    const send = document.createElement('button');
    send.type = 'button';
    send.className = 'mini';
    send.textContent = 'Send';
    send.onclick = () => sendOne(String(e.id || ''));

    row.appendChild(cb);
    row.appendChild(name);
    row.appendChild(dl);
    row.appendChild(send);
    box.appendChild(row);
  });
}


  function loadEmployeesAndMaybeTags() {
    refreshEmployees();
    
  }


  function selectAll(flag) {
    document.querySelectorAll('.empChk').forEach(cb => cb.checked = !!flag);
  }

  function collectForm() {
    const year = Number(document.getElementById('yearSelect').value);
    const employeeIds = Array.from(document.querySelectorAll('.empChk'))
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    return {
      year,
      employeeIds,
      folderId: document.getElementById('folderId').value.trim(),
      slidesTemplateUrl: document.getElementById('slidesTemplateUrl').value.trim(),
      filenamePattern: document.getElementById('filenamePattern').value.trim(),

      // email
      sendEmail: document.getElementById('sendEmail').checked,
      emailColumn: document.getElementById('emailColumn').value.trim(),
      appendGmailSignature: document.getElementById('appendGmailSignature').checked,

      emailSubject: document.getElementById('emailSubject').value.trim(),
      emailBodyHtml: document.getElementById('emailBodyHtml').value,
      cc: document.getElementById('cc').value.trim(),
      bcc: document.getElementById('bcc').value.trim(),
      replyTo: document.getElementById('replyTo').value.trim(),
      senderName: document.getElementById('senderName').value.trim(),
    };
  }

  function downloadOne(employeeId){
    const f = collectForm();
    setStatus(`Generating PDF for ${employeeId}…`);

    google.script.run
      .withSuccessHandler(res => {
        setStatus(`Ready: ${res.fileName}`);
        if (res.fileUrl) window.open(res.fileUrl, '_blank');
      })
      .withFailureHandler(err => setStatus('❌ ' + (err.message || err)))
      .bir2316DownloadOne(f, employeeId);
  }

  function sendOne(employeeId){
    const f = collectForm();
    setStatus(`Sending PDF for ${employeeId}…`);

    google.script.run
      .withSuccessHandler(res => setStatus(`Sent/Created: ${res.fileName}`))
      .withFailureHandler(err => setStatus('❌ ' + (err.message || err)))
      .bir2316SendOne(f, employeeId);
  }

  function downloadSelected(){
    const f = collectForm();
    f.sendEmail = false;

    setStatus('Starting bulk download run…');
    showProgress(true);

    google.script.run
      .withSuccessHandler(() => setStatus('Running…'))
      .withFailureHandler(err => {
        setStatus('❌ ' + (err.message || err));
        showProgress(false);
      })
      .generateBir2316(f);
  }

  function sendSelected(){
    const f = collectForm();
    f.sendEmail = true;

    setStatus('Starting bulk send run…');
    showProgress(true);

    google.script.run
      .withSuccessHandler(() => setStatus('Running…'))
      .withFailureHandler(err => {
        setStatus('❌ ' + (err.message || err));
        showProgress(false);
      })
      .generateBir2316(f);
  }

  function cancelRun() {
    google.script.run.withSuccessHandler(() => {
      setStatus('Cancelled.');
      showProgress(false);
    }).cancelBir2316Run();
  }

  

  function startPolling() {
    if (poller) clearInterval(poller);
    poller = setInterval(() => {
      google.script.run.withSuccessHandler(renderProgress).getBir2316Progress();
    }, 1200);
  }

  function renderProgress(p) {
  if (!p) return;

  const isActive = !!(p.running || p.finished || p.cancelled);

  // ✅ Only let polling update the status when a run is actually active
  if (isActive && p.statusText) setStatus(p.statusText);

  if (p.running) {
    showProgress(true);
    const pct = p.percent || 0;
    const bar = document.getElementById('progressBar');
    bar.style.width = pct + '%';
    bar.textContent = pct + '%';
    document.getElementById('progressStatus').textContent = p.detail || '';
  } else {
    showProgress(false);
  }
}

function showProgress(show) {
  const box = document.getElementById('progressBarContainer');
  box.style.display = show ? 'block' : 'none';

  if (!show) {
    const bar = document.getElementById('progressBar');
    bar.style.width = '0%';
    bar.textContent = '0%';
    document.getElementById('progressStatus').textContent = '';
  }
}


  function setStatus(msg) {
    document.getElementById('status').textContent = msg || '';
  }

  function generateAlphalist1604C() {
  const f = collectForm();

  if (!f.year) {
    setStatus("❌ Please select a Year.");
    return;
  }
  if (!f.folderId) {
    setStatus("❌ Please provide an Output Folder ID/URL.");
    return;
  }

  setStatus("⏳ Generating 1604C Alphalist (.dat)...");

  google.script.run
    .withSuccessHandler(function (res) {
      const fileName = (res && res.fileName) ? res.fileName : ("1604C_" + String(f.year) + ".dat");
      const content = (res && typeof res.content === "string") ? res.content : "";

      if (!content) {
        setStatus("❌ No file content returned.");
        return;
      }

      // ✅ Direct download in browser (no Drive link)
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const objUrl = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = objUrl;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(objUrl), 1000);

      // ✅ Status includes filename (and confirms Drive save)
      const fileId = (res && res.fileId) ? res.fileId : "";
      let msg = "✅ Created in Drive and downloaded: " + fileName;
      if (fileId) msg += "\nDrive File ID: " + fileId;

      if (res && res.counts) {
        msg += "\nS1: " + (res.counts.s1 || 0) + " | S2: " + (res.counts.s2 || 0);
      }

      setStatus(msg);
    })
    .withFailureHandler(function (err) {
      setStatus("❌ " + (err && err.message ? err.message : err));
    })
    .generateBir1604CAlphalist({
      year: Number(f.year),
      folderIdOrUrl: String(f.folderId || "")
    });
}


  

  function reviewTags() {
  const f = collectForm();
  if (!f.year) { setStatus("❌ Please select a Year."); return; }
  if (!f.employeeIds || !f.employeeIds.length) { setStatus("❌ Select at least 1 employee."); return; }

  setStatus("Generating review sheet…");
  showProgress(true); // ✅ show progress bar immediately

  // reset bar UI instantly (poller will override as soon as server updates)
  const bar = document.getElementById('progressBar');
  if (bar) { bar.style.width = '0%'; bar.textContent = '0%'; }
  document.getElementById('progressStatus').textContent = '';

  google.script.run
    .withSuccessHandler(res => {
  showProgress(false); // ✅ hide bar when done
  setStatus(`✅ Review ready: ${res.sheetName}`);
  // ✅ do NOT open a new tab
})

    .withFailureHandler(err => {
      showProgress(false); // ✅ hide bar on error
      setStatus("❌ " + (err && err.message ? err.message : err));
    })
    .bir2316ReviewTags(f);
}


  function saveSettings(){
  const f = collectForm();
  setStatus("Saving settings…");

  google.script.run
    .withSuccessHandler(() => setStatus("✅ Saved."))
    .withFailureHandler(err => setStatus("❌ " + (err.message || err)))
    .saveBir2316Settings(f);
}


  function populateEmailColumnDropdown(headers, selectedValue) {
    const sel = document.getElementById('emailColumn');
    sel.innerHTML = '';

    if (!headers || !headers.length) {
      const opt = document.createElement('option');
      opt.value = 'Company Email';
      opt.textContent = 'Company Email';
      sel.appendChild(opt);
      sel.value = 'Company Email';
      return;
    }

    headers.forEach(h => {
      const opt = document.createElement('option');
      opt.value = h;
      opt.textContent = h;
      sel.appendChild(opt);
    });

    if (selectedValue && Array.from(sel.options).some(o => o.value === selectedValue)) {
      sel.value = selectedValue;
    }
  }
</script>


</body>
</html>
