steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/${_SERVICE}:${SHORT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/${_SERVICE}:latest'
      - '.'

  # Push to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/${_SERVICE}'

  # Run Prisma migrations via Cloud SQL Auth Proxy
  - name: 'gcr.io/cloud-sql-connectors/cloud-sql-proxy:2'
    args: ['${_DB_CONNECTION}', '--port=5432', '--exit-zero-on-sigterm']
    id: 'sql-proxy'
    waitFor: ['-']

  - name: 'node:20-slim'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        npm ci --omit=dev
        npx prisma migrate deploy
    env:
      - 'DATABASE_URL=postgresql://${_DB_USER}:$$DB_PASS@localhost:5432/${_DB_NAME}?schema=public'
    secretEnv: ['DB_PASS']
    waitFor: ['sql-proxy']

  # Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE}'
      - '--image=${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/${_SERVICE}:${SHORT_SHA}'
      - '--region=${_REGION}'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--port=8080'
      - '--memory=512Mi'
      - '--cpu=1'
      - '--min-instances=0'
      - '--max-instances=10'
      - '--set-env-vars=NODE_ENV=production'
      - '--add-cloudsql-instances=${_DB_CONNECTION}'
      - '--set-secrets=DATABASE_URL=payroll-db-url:latest,NEXTAUTH_SECRET=nextauth-secret:latest'

substitutions:
  _REGION: asia-southeast1
  _REPO: payroll-saas
  _SERVICE: payroll-web
  _DB_CONNECTION: ''  # project:region:instance â€” set in trigger
  _DB_USER: payroll_app
  _DB_NAME: payroll_saas

availableSecrets:
  secretManager:
    - versionName: projects/${PROJECT_ID}/secrets/payroll-db-password/versions/latest
      env: DB_PASS

options:
  logging: CLOUD_LOGGING_ONLY
